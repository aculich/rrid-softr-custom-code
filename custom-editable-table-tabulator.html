<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabulator with Airtable</title>
    <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@6.2.1/dist/css/tabulator.min.css">
</head>
<body>
    <div id="table"></div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.7.2/dist/axios.min.js"></script>
    <script src="https://unpkg.com/tabulator-tables@6.2.1/dist/js/tabulator.min.js"></script>
    <script>
        // const airtableToken = 'patMYPsrw97yxUfyH.1c3e9172d251d9029d562a091759bab69d1e345aa74c31307118cdaf43ba3d60';
        const airtableToken = 'patC7gZRJIhFsGTnX.c9c88d1c2afe9a55e8db1b060c0dba155ec7274f37c6a5bbea30e54881f78657'; // Aaron's key with write permissions
        const baseId = 'appAYosfmfSuHWiBT';
        const tableId = 'tblHRiK0758oaO4jI';

        async function fetchData() {
            const url = `https://api.airtable.com/v0/${baseId}/${tableId}`;
            const headers = { Authorization: `Bearer ${airtableToken}` };
            const response = await axios.get(url, { headers });
            return response.data.records.map(record => {
                const fields = record.fields;
                // Rename "Preprint ID (pulled)" to "preprintId"
                fields.preprintId = fields["Preprint ID (pulled)"];
                delete fields["Preprint ID (pulled)"];
                return { id: record.id, ...fields };
            });
        }

        async function updateAirtable(recordId, fieldName, currentValue) {
            const url = `https://api.airtable.com/v0/${baseId}/${tableId}/${recordId}`;
            const headers = { Authorization: `Bearer ${airtableToken}`, 'Content-Type': 'application/json' };
            const data = {
                fields: {
                    [fieldName]: currentValue
                }
            };

            try {
                await axios.patch(url, data, { headers });
                console.log(`Updated record ${recordId}: ${fieldName} = ${currentValue}`);
            } catch (error) {
                console.error(`Error updating record ${recordId}:`, error);
            }
        }

        fetchData().then(data => {
            const columns = Object.keys(data[0]).map(key => ({ title: key, field: key, editor: "input" }));

            // Ensure preprintId is the first column with title "Preprint ID"
            const specialColumns = [
                { title: "Preprint ID", field: "preprintId", editor: "input" },
                { title: "Status", field: "Status", editor: "input" },
                { title: "Quality Check Reviewer Comments", field: "Quality Check Reviewer Comments", editor: "input" },
                { title: "Student Reply Comments", field: "Student Reply Comments", editor: "input" }
            ];

            const reorderedColumns = specialColumns.concat(columns.filter(col => !specialColumns.find(special => special.field === col.field)));

            const table = new Tabulator("#table", {
                data: data,
                columns: reorderedColumns,
                groupBy: "preprintId", // Group rows by Preprint ID
                layout: "fitDataTable", // Fit columns to width of table
                movableColumns: true, // Allow column order to be changed
                groupStartOpen: true, // Start with groups expanded
                responsiveLayout: "hide",
                tooltips: true,
                addRowPos: "top",
                history: true,
                pagination: "local",
                paginationSize: 100,
                resizableRows: true,
                initialSort: [
                    { column: "Status", dir: "asc" }
                ]
            });

            table.on("cellEdited", function(cell) {
                const row = cell.getRow();
                const rowIndex = row.getPosition();
                const fieldName = cell.getColumn().getField();
                const recordId = row.getData().id;
                const preprintId = row.getData().preprintId;
                const previousValue = cell.getOldValue();
                const currentValue = cell.getValue();

                const logMessage = `
                    Cell edited at row ${rowIndex}
                    Field Name: ${fieldName}
                    Record Id: ${recordId}
                    Preprint Id: ${preprintId}
                    Previous value: ${previousValue}
                    Current value: ${currentValue}
                `;

                console.log(logMessage);
                // alert(logMessage);

                // Update Airtable with the new value
                updateAirtable(recordId, fieldName, currentValue);
            });
        }).catch(error => {
            console.error('Error fetching data from Airtable:', error);
        });
    </script>
</body>
</html>
